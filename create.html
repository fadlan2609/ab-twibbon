<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Twibbon - Twibbon App</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <i class="fas fa-magic"></i>
                <span>TwibbonApp</span>
            </div>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="create.html" class="active">Buat Twibbon</a>
                <a href="#" id="logoutBtn">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Create Form -->
    <section class="create-section">
        <div class="container">
            <div class="create-card animate-pop-in">
                <h2>Buat Twibbon Baru</h2>
                <p class="subtitle">Upload template twibbon dengan background transparan (PNG)</p>

                <form id="createForm" class="create-form">
                    <div class="form-group">
                        <label for="twibbonName">Nama Twibbon</label>
                        <input type="text" id="twibbonName" placeholder="Contoh: HUT RI ke-78" required>
                    </div>

                    <div class="form-group">
                        <label for="twibbonDescription">Deskripsi (Opsional)</label>
                        <textarea id="twibbonDescription" placeholder="Deskripsikan twibbon ini..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Upload Template Twibbon (PNG Transparan)</label>
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop file di sini atau klik untuk memilih</p>
                            <p class="file-info">Format: PNG dengan background transparan</p>
                            <input type="file" id="twibbonFile" accept="image/png" hidden>
                        </div>
                        <div id="previewContainer" style="display: none;">
                            <img id="imagePreview" alt="Preview">
                            <button type="button" class="btn btn-small" id="changeImageBtn">Ganti Gambar</button>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-magic"></i>
                        Buat Twibbon & Generate Link
                    </button>
                </form>

                <div id="resultLink" class="result-link" style="display: none;">
                    <h3>Link Twibbon Berhasil Dibuat!</h3>
                    <div class="link-box">
                        <input type="text" id="generatedLink" readonly>
                        <button class="btn btn-small" id="copyLinkBtn">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p class="link-note">Bagikan link ini ke teman-temanmu!</p>
                </div>
            </div>
        </div>
    </section>

    <script src="js/main.js"></script>

    <script type="module">
import { createTwibbon } from './js/supabase.js'

document.addEventListener('DOMContentLoaded', function() {
    const createForm = document.getElementById('createForm')
    const fileInput = document.getElementById('twibbonFile')
    const uploadArea = document.getElementById('uploadArea')
    const previewContainer = document.getElementById('previewContainer')
    const imagePreview = document.getElementById('imagePreview')
    const resultLink = document.getElementById('resultLink')
    const generatedLink = document.getElementById('generatedLink')
    
    // Preview gambar
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0]
        if (file) {
            // Cek tipe file
            if (!file.type.startsWith('image/')) {
                alert('Harap upload file gambar!')
                this.value = ''
                return
            }
            
            // Cek ukuran (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File terlalu besar! Maksimal 5MB')
                this.value = ''
                return
            }
            
            const reader = new FileReader()
            reader.onload = function(e) {
                imagePreview.src = e.target.result
                uploadArea.style.display = 'none'
                previewContainer.style.display = 'block'
            }
            reader.readAsDataURL(file)
        }
    })
    
    // Upload area click
    uploadArea.addEventListener('click', () => {
        fileInput.click()
    })
    
    // Ganti gambar
    document.getElementById('changeImageBtn')?.addEventListener('click', () => {
        uploadArea.style.display = 'block'
        previewContainer.style.display = 'none'
        fileInput.value = ''
    })
    
    // Submit form
    createForm.addEventListener('submit', async function(e) {
        e.preventDefault()
        
        const name = document.getElementById('twibbonName').value.trim()
        const description = document.getElementById('twibbonDescription').value.trim()
        const file = fileInput.files[0]
        
        if (!name) {
            alert('Nama twibbon harus diisi!')
            return
        }
        
        if (!file) {
            alert('Harap upload template twibbon!')
            return
        }
        
        // Tampilkan loading
        const submitBtn = this.querySelector('button[type="submit"]')
        const originalText = submitBtn.innerHTML
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...'
        submitBtn.disabled = true
        
        try {
            const result = await createTwibbon(name, description, file)
            
            // Generate link
            const link = `${window.location.origin}/generate.html?id=${result.id}`
            generatedLink.value = link
            resultLink.style.display = 'block'
            
            // Reset form
            createForm.reset()
            uploadArea.style.display = 'block'
            previewContainer.style.display = 'none'
            
            alert('✅ Twibbon berhasil dibuat!')
        } catch (error) {
            alert('❌ Gagal: ' + error.message)
        } finally {
            submitBtn.innerHTML = originalText
            submitBtn.disabled = false
        }
    })
    
    // Copy link
    document.getElementById('copyLinkBtn')?.addEventListener('click', function() {
        generatedLink.select()
        navigator.clipboard.writeText(generatedLink.value)
        alert('Link disalin!')
    })
})
</script>
</body>

</html>
